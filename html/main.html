<!DOCTYPE html>
<html>

  <head>
    <script type="text/javascript">
      function performLoaded(e){
        var settings = safari.extension.secureSettings;

        if (e.name != 'page-loaded') { return; };
        if (!settings.accessToken || settings.indexingPaused === true) { return; };

        console.log('Posting page contents.')

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "http://fetching.io/documents", true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        xhr.send(
          "body=" + encodeURIComponent(e.message.body) +
          "&title=" + encodeURIComponent(e.message.title) +
          "&token=" + encodeURIComponent(safari.extension.secureSettings.accessToken) +
          "&url=" + encodeURIComponent(e.message.url)
        );
      }

      safari.application.addEventListener("message", performLoaded, true);

    </script>
  </head>

  <body>
  </body>

</html>